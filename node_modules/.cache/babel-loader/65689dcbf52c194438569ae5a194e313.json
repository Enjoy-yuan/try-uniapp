{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js!/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/RF/expBase/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/RF/expBase/index.vue","mtime":1596610933417},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _objectSpread from \"/Users/yuan/Documents/\\u5927\\u5510\\u5E7F\\u7535/dt-web/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport * as api from '@/api/project/eas/rf/exBase';\nimport * as deviceApi from '@/api/project/eas/el/equipmentArchives';\nimport * as failureOrder from '@/api/project/eas/fm/failureRegister';\nimport Pagination from '@/components/Pagination';\nimport { mapState } from 'vuex';\nimport deviceType from \"../../components/deviceTypeSelect\";\nimport faultType from \"../../components/faultTypeSelect\";\nimport imgUpload from \"../../components/imgUpload\";\nimport fileUpload from \"../../components/fileUpload\";\nexport default {\n  name: 'expBase',\n  components: {\n    Pagination: Pagination,\n    faultType: faultType,\n    deviceType: deviceType,\n    imgUpload: imgUpload,\n    fileUpload: fileUpload\n  },\n  data: function data() {\n    return {\n      list: [],\n      listSub: [],\n      baseList: [],\n      parts: [],\n      device: [],\n      workOrder: [],\n      faultCodes: [],\n      selectlistRow: [],\n      imgs: [],\n      total: 0,\n      total2: 0,\n      theight: 0,\n      //表格高度\n      theight2: 0,\n      listQuery: {\n        page: true,\n        currentPage: 1,\n        pageSize: 10\n      },\n      listQuery2: {\n        page: true,\n        currentPage: 1,\n        pageSize: 10\n      },\n      tabName: 'sbtp',\n      rules: {\n        experienceType: [{\n          required: true,\n          message: '经验类型不能为空',\n          trigger: 'blur'\n        }],\n        disposeDescription: [{\n          required: true,\n          message: '处理描述不能为空',\n          trigger: 'blur'\n        }],\n        faultDescription: [{\n          required: true,\n          message: '故障描述不能为空',\n          trigger: 'blur'\n        }]\n      },\n      temp: {\n        deviceCode: undefined,\n        deviceTypeCode: undefined,\n        disposeDescription: undefined,\n        experienceType: undefined,\n        faultCode: undefined,\n        faultDescription: undefined,\n        faultNumber: undefined,\n        faultTypeCode: undefined\n      },\n      temp2: {\n        functionCode: undefined,\n        fileType: 'img',\n        category: undefined\n      },\n      files: [],\n      fileList: [],\n      importDialogVisible: false,\n      dialogStatus: 'create',\n      tableKey: [0, 1, 2]\n    };\n  },\n  watch: {\n    'listQuery.deviceTypeCode': function listQueryDeviceTypeCode(value) {\n      this.queryParts(value);\n      this.listQuery.partCode = undefined;\n    },\n    'temp.deviceTypeCode': function tempDeviceTypeCode(val, oldVal) {\n      this.queryFaultCode();\n\n      if (oldVal) {\n        this.temp.faultCode = '';\n      }\n    },\n    'dt_experience_type': function dt_experience_type() {\n      if (this.list && this.list.length) {\n        var options = [this.dt_experience_state, this.dt_experience_type];\n        this.list = this.$myFun.srmCodeToName(this.list, options, ['state', 'experienceType']);\n      }\n    }\n  },\n  computed: _objectSpread({}, mapState({\n    dt_experience_state: function dt_experience_state(state) {\n      return state.eamDict.dt_experience_state;\n    },\n    dt_experience_type: function dt_experience_type(state) {\n      return state.eamDict.dt_experience_type;\n    },\n    dt_file_type: function dt_file_type(state) {\n      return state.eamDict.dt_file_type;\n    },\n    dt_file_equipment: function dt_file_equipment(state) {\n      return state.eamDict.dt_file_equipment;\n    }\n  }), {\n    getFunctionCode: function getFunctionCode() {\n      if (this.selectlistRow.length) {\n        return this.selectlistRow[this.selectlistRow.length - 1].experienceCode;\n      } else {\n        return '';\n      }\n    }\n  }),\n  created: function created() {\n    this.getSetDefaults();\n  },\n  mounted: function mounted() {\n    var _this = this;\n\n    this.$store.dispatch('eamDict/getDicData', ['dt_experience_state', 'dt_experience_type', 'dt_file_type', 'dt_file_equipment']);\n    this.setTableHeight(); //表格高度自适应\n\n    window.onresize = function () {\n      _this.setTableHeight();\n    };\n\n    this.getList();\n    this.queryDevice();\n    this.queryFaultCode();\n  },\n  methods: {\n    forceUpdate: function forceUpdate() {\n      this.$forceUpdate();\n    },\n    getWorkOrder: function getWorkOrder(val) {\n      var _this2 = this;\n\n      if (!val) {\n        this.temp.deviceCode = undefined;\n        this.temp.deviceName = undefined;\n      }\n\n      this.workOrder.forEach(function (item) {\n        if (item.faultNumber == val) {\n          _this2.temp.deviceCode = item.deviceCode;\n          _this2.temp.deviceName = item.deviceName;\n          return false;\n        }\n      });\n    },\n    queryParts: function queryParts(typeCode) {\n      var _this3 = this;\n\n      api.queryParts(typeCode).then(function (res) {\n        _this3.parts = res.data;\n      });\n    },\n    queryFaultCode: function queryFaultCode() {\n      var _this4 = this;\n\n      api.queryFaultCode({\n        deviceTypeCode: this.temp.deviceTypeCode\n      }).then(function (res) {\n        _this4.faultCodes = res.data;\n      });\n    },\n    queryDevice: function queryDevice() {\n      var _this5 = this;\n\n      deviceApi.queryRecords().then(function (res) {\n        _this5.device = res.data;\n      }); // 查询待修故障单\n\n      failureOrder.queryRecords({\n        state: 'fs20'\n      }).then(function (res) {\n        _this5.workOrder = res.data;\n      }); // 查询故障代码\n    },\n    //查主表\n    getList: function getList() {\n      var _this6 = this;\n\n      api.queryRecords(this.listQuery).then(function (res) {\n        _this6.list = res.data.list;\n        var options = [_this6.dt_experience_state, _this6.dt_experience_type];\n        _this6.list = _this6.$myFun.srmCodeToName(_this6.list, options, ['state', 'experienceType']);\n        _this6.total = res.data.pages.count;\n      });\n    },\n    getSubList: function getSubList() {\n      var _this7 = this;\n\n      if (!this.selectlistRow.length) {\n        this.listSub = [];\n        return false;\n      }\n\n      api.queryFile(Object.assign({\n        functionCode: this.selectlistRow[this.selectlistRow.length - 1].experienceCode,\n        fileType: this.tabName == 'sbtp' ? 'img' : 'document'\n      }, this.listQuery2)).then(function (res) {\n        _this7.imgs = [];\n        _this7.listSub = res.data.list;\n        _this7.total2 = res.data.pages.count;\n\n        if (_this7.tabName == 'sbtp') {\n          for (var i = 0; i < _this7.listSub.length; i++) {\n            api.queryPic(_this7.listSub[i].readName).then(function (res) {\n              res.config.url = res.config.url.replace(process.env.VUE_APP_BASE_API10, process.env.VUE_APP_BASE_API10_URL);\n\n              _this7.imgs.push(res.config.url);\n            });\n          }\n        }\n      });\n    },\n    selectRow: function selectRow(val) {\n      this.selectlistRow = val;\n\n      if (this.selectlistRow.length != 0) {\n        this.getSubList();\n        this.temp2.functionCode = this.selectlistRow[this.selectlistRow.length - 1].experienceCode;\n      } else {\n        this.listSub = [];\n        this.imgs = [];\n        this.temp2 = {\n          functionCode: undefined,\n          fileType: this.tabName == 'sbtp' ? 'img' : 'document',\n          category: undefined\n        };\n      }\n    },\n    rowClick: function rowClick(val) {\n      this.$refs.mainList.toggleRowSelection(val);\n    },\n    //表格高度计算\n    setTableHeight: function setTableHeight() {\n      this.theight = this.$myFun.getSingleTbHeight() - 200;\n      this.theight2 = this.$myFun.getSingleTbHeight() - 200 + 43;\n    },\n    handleQuery: function handleQuery() {\n      //查询\n      this.listQuery.currentPage = 1;\n      this.getList();\n    },\n    handleCreate: function handleCreate() {\n      this.resetTemp();\n      this.dialogStatus = 'create';\n      this.importDialogVisible = true;\n    },\n    handleUpdate: function handleUpdate(row) {\n      var _this8 = this;\n\n      this.dialogStatus = 'update';\n      this.importDialogVisible = true;\n      this.$nextTick(function () {\n        _this8.temp = row;\n        _this8.$refs.tempDeviceType.valueTitle = row.faultTypeName;\n        _this8.$refs.tempFaultType.valueTitle = row.deviceTypeName;\n      });\n    },\n    handleCommit: function handleCommit(row) {\n      var _this9 = this;\n\n      this.$confirm(\"\\u662F\\u5426\\u8981\\u63D0\\u4EA4\\u7ECF\\u9A8C\\u7F16\\u7801\".concat(row.experienceCode, \"?\"), '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(function () {\n        api.submitRecords(row.experienceCode).then(function (res) {\n          if (res.status == 201) {\n            _this9.getList();\n\n            _this9.importDialogVisible = false;\n\n            _this9.$message({\n              title: '成功',\n              message: '提交成功',\n              type: 'success',\n              duration: 2000\n            });\n          }\n        });\n      }).catch(function () {\n        _this9.$message({\n          type: 'info',\n          message: '已取消'\n        });\n      });\n    },\n    create: function create() {\n      var _this10 = this;\n\n      this.$refs.temp.validate(function (valid) {\n        if (valid) {\n          api.addRecords(_this10.temp).then(function (res) {\n            if (res.status == 200) {\n              _this10.getList();\n\n              _this10.importDialogVisible = false;\n\n              _this10.$message({\n                title: '成功',\n                message: '新增成功',\n                type: 'success',\n                duration: 2000\n              });\n            }\n          });\n        }\n      });\n    },\n    update: function update() {\n      var _this11 = this;\n\n      this.$refs.temp.validate(function (valid) {\n        if (valid) {\n          api.patchRecords(_this11.temp.experienceCode, _this11.temp).then(function (res) {\n            if (res.status == 201) {\n              _this11.getList();\n\n              _this11.importDialogVisible = false;\n\n              _this11.$message({\n                title: '成功',\n                message: '修改成功',\n                type: 'success',\n                duration: 2000\n              });\n            }\n          });\n        }\n      });\n    },\n    //删除列表\n    handleDelete: function handleDelete() {\n      var _this12 = this;\n\n      if (this.selectlistRow.length) {\n        this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {\n          confirmButtonText: '确定',\n          cancelButtonText: '取消',\n          type: 'warning'\n        }).then(function () {\n          var tmp = _this12.selectlistRow.map(function (item) {\n            return item.experienceCode;\n          });\n\n          api.deleteRecords(tmp).then(function (res) {\n            if (res.status == 204) {\n              _this12.getList();\n\n              _this12.$message({\n                title: '成功',\n                message: '删除成功',\n                type: 'success',\n                duration: 2000\n              });\n            }\n          });\n        }).catch(function () {\n          _this12.$message({\n            type: 'info',\n            message: '已取消删除'\n          });\n        });\n      } else {\n        this.$message({\n          title: '警告',\n          message: '请选择信息',\n          type: 'warning'\n        });\n      }\n    },\n    handleClick: function handleClick() {\n      if (this.tabName == 'sbtp') {\n        this.temp2.fileType = 'img';\n      } else if (this.tabName == 'sbfj') {\n        this.temp2.fileType = 'document';\n      }\n\n      this.files = [];\n      this.imgs = [];\n      this.getSubList();\n    },\n    fileExceed: function fileExceed() {\n      this.$message.error('一次最多上传10个文件');\n    },\n    beforeUpload: function beforeUpload(file) {\n      var isJPG = file.type === 'image/jpeg';\n      var isPNG = file.type === 'image/png';\n      var isPG = isJPG || isPNG; //限制图片格式为jpg / png\n\n      var isLt2M = file.size / 1024 / 1024 < 10; //限制图片大小\n\n      if (!isPG) {\n        this.$message.error('上传头像图片只能是 JPG 或 PNG 格式!');\n      }\n\n      if (!isLt2M) {\n        this.$message.error('上传头像图片大小不能超过 10MB!');\n      }\n\n      return isPG && isLt2M;\n    },\n    handleFile: function handleFile(file, fileList) {\n      this.files = fileList;\n    },\n    handleUpload: function handleUpload() {\n      var _this13 = this;\n\n      if (this.temp2.functionCode == undefined) {\n        this.$message({\n          title: '警告',\n          message: '请选择设备',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      if (this.temp2.category == undefined) {\n        this.$message({\n          title: '警告',\n          message: '请选择类别',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      if (!this.files.length) {\n        this.$message({\n          title: '警告',\n          message: '请选择文件',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      var data = new FormData();\n      this.files.forEach(function (file) {\n        data.append('files', file.raw);\n      });\n      api.uploadFile(this.temp2.functionCode, data, this.temp2).then(function (res) {\n        if (res.status == 200) {\n          _this13.$message({\n            title: '成功',\n            message: '上传成功',\n            type: 'success',\n            duration: 2000\n          });\n        }\n\n        _this13.getSubList();\n\n        _this13.$refs.upload1.clearFiles();\n\n        _this13.$refs.upload2.clearFiles();\n\n        _this13.files = [];\n      }).catch(function () {\n        _this13.$message({\n          title: '警告',\n          message: '不支持的文件类型',\n          type: 'warning'\n        });\n\n        _this13.files = [];\n      });\n    },\n    resetTemp: function resetTemp() {\n      var _this14 = this;\n\n      this.temp = {\n        deviceCode: undefined,\n        deviceTypeCode: undefined,\n        disposeDescription: undefined,\n        experienceType: undefined,\n        faultCode: undefined,\n        faultDescription: undefined,\n        faultNumber: undefined,\n        faultTypeCode: undefined\n      };\n      this.$nextTick(function () {\n        _this14.$refs.tempDeviceType.valueTitle = '';\n        _this14.$refs.tempFaultType.valueTitle = '';\n      });\n    },\n    getSetDefaults: function getSetDefaults() {\n      this.$viewer.setDefaults({\n        inline: true,\n        button: true,\n        //右上角按钮\n        navbar: true,\n        //底部缩略图\n        title: false,\n        //当前图片标题\n        toolbar: true,\n        //底部工具栏\n        tooltip: false,\n        //显示缩放百分比\n        movable: true,\n        //是否可以移动\n        zoomable: false,\n        //是否可以缩放\n        rotatable: false,\n        //是否可旋转\n        scalable: false,\n        //是否可翻转\n        transition: false,\n        //使用 CSS3 过度\n        fullscreen: false,\n        //播放时是否全屏\n        keyboard: true,\n        //是否支持键盘\n        url: 'data-source',\n        viewed: function viewed(e) {\n          // 索引为 1 的图片旋转20度\n          if (e.detail.index === 1) {\n            this.viewer.rotate(20);\n          }\n        }\n      });\n    },\n    handleDeleteFile: function handleDeleteFile(row) {\n      var _this15 = this;\n\n      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(function () {\n        api.deleteFile({\n          fileCode: row.fileCode\n        }).then(function (res) {\n          if (res.status == 204) {\n            _this15.getSubList();\n\n            _this15.$message({\n              title: '成功',\n              message: '删除成功',\n              type: 'success',\n              duration: 2000\n            });\n          }\n        });\n      }).catch(function () {\n        _this15.$message({\n          type: 'info',\n          message: '已取消删除'\n        });\n      });\n    },\n    handleDownloadFile: function handleDownloadFile(row) {\n      api.download(row.readName).then(function (res) {\n        var blob = new Blob([res.data], {\n          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document;charset=utf-8'\n        }); //application/vnd.openxmlformats-officedocument.wordprocessingml.document这里表示doc类型\n\n        var contentDisposition = res.headers['content-disposition']; //从response的headers中获取filename, 后端response.setHeader(\"Content-disposition\", \"attachment; filename=xxxx.docx\") 设置的文件名;\n\n        var filename = contentDisposition.substring(contentDisposition.indexOf('=') + 1);\n        var downloadElement = document.createElement('a');\n        var href = window.URL.createObjectURL(blob); //创建下载的链接\n\n        downloadElement.style.display = 'none';\n        downloadElement.href = href;\n        downloadElement.download = filename; //下载后文件名\n\n        document.body.appendChild(downloadElement);\n        downloadElement.click(); //点击下载\n\n        document.body.removeChild(downloadElement); //下载完成移除元素\n\n        window.URL.revokeObjectURL(href); //释放掉blob对象\n      });\n    }\n  }\n};",null]}