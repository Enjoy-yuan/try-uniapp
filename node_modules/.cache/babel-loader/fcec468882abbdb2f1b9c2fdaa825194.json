{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js!/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/components/imgUpload/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/components/imgUpload/index.vue","mtime":1596610933463},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/web.dom.iterable\";\nimport _objectSpread from \"/Users/yuan/Documents/\\u5927\\u5510\\u5E7F\\u7535/dt-web/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport * as api from '@/api/project/eas/file/file';\nimport Pagination from '@/components/Pagination';\nimport { mapState } from 'vuex';\nexport default {\n  name: 'imgUpload',\n  components: {\n    Pagination: Pagination\n  },\n  props: {\n    // 右侧第一个lable和placeholder\n    titleText: {\n      type: String,\n      default: '业务代码'\n    },\n    // 父级传过来用于传给接口的增删改查的code，如经验库传experienceCode，设备台账传deviceCode等等...\n    functionCode: {\n      type: String,\n      default: ''\n    },\n    // 针对不同页面的业务，需要不同的待选附件类别，从父级过滤好之后传进来\n    categoryData: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    }\n  },\n  data: function data() {\n    return {\n      list: [],\n      selectlistRow: [],\n      imgs: [],\n      total: 0,\n      theight: 0,\n      //表格高度\n      listQuery: {\n        page: true,\n        currentPage: 1,\n        pageSize: 10\n      },\n      temp: {\n        functionCode: undefined,\n        fileType: 'img',\n        category: undefined\n      },\n      files: [],\n      fileList: [],\n      tableKey: 0,\n      viewer: null\n    };\n  },\n  watch: {\n    functionCode: function functionCode(val) {\n      if (val) {\n        this.temp.functionCode = this.functionCode;\n        this.getList();\n      } else {\n        this.list = [];\n        this.temp = {\n          functionCode: undefined,\n          fileType: 'img',\n          category: undefined\n        };\n        this.imgs = [];\n        this.$refs.viewer.rebuildViewer;\n\n        if (this.viewer != null) {\n          this.viewer.style.display = 'none';\n        }\n      }\n    },\n    dt_file_type: function dt_file_type() {\n      if (this.list) {\n        var options = [this.categoryData, this.dt_file_type];\n        this.list = this.$myFun.srmCodeToName(this.list, options, ['category', 'fileType']);\n      }\n    }\n  },\n  computed: _objectSpread({}, mapState({\n    dt_file_type: function dt_file_type(state) {\n      return state.eamDict.dt_file_type;\n    }\n  })),\n  created: function created() {\n    this.getSetDefaults();\n  },\n  mounted: function mounted() {\n    var _this = this;\n\n    this.$store.dispatch('eamDict/getDicData', ['dt_file_type']);\n    this.setTableHeight(); //表格高度自适应\n\n    window.onresize = function () {\n      _this.setTableHeight();\n    };\n\n    this.getList();\n  },\n  destroyed: function destroyed() {\n    this.getSetDefaults();\n    this.getList();\n  },\n  methods: {\n    getList: function getList() {\n      var _this2 = this;\n\n      api.queryFile(Object.assign(this.temp, this.listQuery)).then(function (res) {\n        var options = [_this2.categoryData, _this2.dt_file_type];\n        _this2.list = _this2.$myFun.srmCodeToName(res.data.list, options, ['category', 'fileType']);\n        _this2.total = res.data.pages.count;\n        _this2.imgs = []; // 查询图片\n\n        var imgbox = [];\n\n        _this2.list.forEach(function (i) {\n          api.queryPic(i.readName).then(function (res) {\n            imgbox.push(res.config.url);\n          });\n        });\n\n        _this2.imgs = imgbox;\n\n        _this2.list.reverse();\n\n        if (_this2.list.length == 0 && _this2.viewer != null) {\n          _this2.viewer.style.display = 'none';\n        } else if (_this2.list.length && _this2.viewer != null) {\n          _this2.viewer.style.display = 'block';\n        }\n      });\n    },\n    //表格高度计算\n    setTableHeight: function setTableHeight() {\n      this.theight = this.$myFun.getSingleTbHeight() - 200 + 43;\n    },\n    handleQuery: function handleQuery() {\n      //查询\n      this.listQuery.currentPage = 1;\n      this.getList();\n    },\n    fileLimit: function fileLimit(file) {\n      var isLt10M = file.size / 1024 / 1024 < 10;\n\n      if (!isLt10M) {\n        this.$message({\n          message: '上传文件大小不能超过 10MB!',\n          type: 'warning'\n        });\n      }\n\n      return isLt10M;\n    },\n    fileExceed: function fileExceed() {\n      this.$message.error('一次最多上传10个文件');\n    },\n    handleFile: function handleFile(file, fileList) {\n      this.files = fileList;\n    },\n    uploadFile: function uploadFile() {},\n    handleUpload: function handleUpload() {\n      var _this3 = this;\n\n      if (this.temp.functionCode == undefined) {\n        this.$message({\n          title: '警告',\n          message: '请选择设备',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      if (this.temp.category == undefined) {\n        this.$message({\n          title: '警告',\n          message: '请选择类别',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      if (!this.files.length) {\n        this.$message({\n          title: '警告',\n          message: '请选择文件',\n          type: 'warning'\n        });\n        return false;\n      }\n\n      var data = new FormData();\n      this.files.forEach(function (file) {\n        data.append('files', file.raw);\n      });\n      api.uploadFile(this.temp.functionCode, data, this.temp).then(function (res) {\n        if (res.status == 200) {\n          _this3.$message({\n            title: '成功',\n            message: '上传成功',\n            type: 'success',\n            duration: 2000\n          });\n        }\n\n        _this3.getList();\n\n        _this3.files = [];\n        _this3.fileList = [];\n      }).catch(function () {\n        _this3.$message({\n          title: '警告',\n          message: '不支持的文件类型',\n          type: 'warning'\n        });\n\n        _this3.files = [];\n        _this3.fileList = [];\n      });\n    },\n    getSetDefaults: function getSetDefaults() {\n      var _this4 = this;\n\n      this.$viewer.setDefaults({\n        inline: true,\n        button: true,\n        //右上角按钮\n        navbar: true,\n        //底部缩略图\n        title: false,\n        //当前图片标题\n        toolbar: true,\n        //底部工具栏\n        tooltip: false,\n        //显示缩放百分比\n        movable: true,\n        //是否可以移动\n        zoomable: false,\n        //是否可以缩放\n        rotatable: false,\n        //是否可旋转\n        scalable: false,\n        //是否可翻转\n        transition: false,\n        //使用 CSS3 过度\n        fullscreen: false,\n        //播放时是否全屏\n        keyboard: true,\n        //是否支持键盘\n        url: 'data-source',\n        ready: function ready() {\n          // 组件以初始化\n          _this4.viewer = document.querySelector('.viewer-container');\n        }\n      });\n    },\n    handleDeleteFile: function handleDeleteFile(row) {\n      var _this5 = this;\n\n      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {\n        confirmButtonText: '确定',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(function () {\n        api.deleteFile({\n          fileCode: row.fileCode\n        }).then(function (res) {\n          if (res.status == 204) {\n            _this5.getList();\n\n            _this5.$message({\n              title: '成功',\n              message: '删除成功',\n              type: 'success',\n              duration: 2000\n            });\n          }\n        });\n      }).catch(function () {\n        _this5.$message({\n          type: 'info',\n          message: '已取消删除'\n        });\n      });\n    },\n    handleDownloadFile: function handleDownloadFile(row) {\n      api.download(row.readName).then(function (res) {\n        var blob = new Blob([res.data], {\n          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document;charset=utf-8'\n        });\n        var contentDisposition = res.headers['content-disposition']; //从response的headers中获取filename, 后端response.setHeader(\"Content-disposition\", \"attachment; filename=xxxx.docx\") 设置的文件名;\n\n        var filename = contentDisposition.substring(contentDisposition.indexOf('=') + 1);\n        var downloadElement = document.createElement('a');\n        var href = window.URL.createObjectURL(blob); //创建下载的链接\n\n        downloadElement.style.display = 'none';\n        downloadElement.href = href;\n        downloadElement.download = filename; //下载后文件名\n\n        document.body.appendChild(downloadElement);\n        downloadElement.click(); //点击下载\n\n        document.body.removeChild(downloadElement); //下载完成移除元素\n\n        window.URL.revokeObjectURL(href); //释放掉blob对象\n      });\n    }\n  }\n};",null]}