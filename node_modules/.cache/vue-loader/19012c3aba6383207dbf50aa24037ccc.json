{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/WMS/productionMaterial/pullerStorage/content/contentRegister.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/WMS/productionMaterial/pullerStorage/content/contentRegister.vue","mtime":1596610934161},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport * as api from \"@/api/project/wms/productionMaterial/pullerStorage\"\nimport Pagination from \"@/components/Pagination\";\nimport { DT_ORG_TYPE } from '@/utils/constant'\nimport { mapState } from 'vuex';\nimport AuthoType from '@/components/Select/AuthoType.vue'//权限类型下拉组件\n\nexport default {\n    name: \"Register\",\n    components: { Pagination, AuthoType },\n    data () {\n        return {\n            theight: 0,\n            list: null,\n            listSub: null,\n            DT_ORG_TYPE: DT_ORG_TYPE,\n            total: 0,\n            rangeTime: \"\",\n            selectRows: [],\n            selectSubRows: [],\n            wlxzDialogFormVisible: false,\n            supplierRows: [],\n            wlxzRows: [],\n            queryState: ['ADD', 'PART'],\n            listQuery: {\n                page: true,\n                currentPage: 1,\n                pageSize: 10,\n                arrivalOrgCode: '',\n                warehouseCode: '',\n                supplierName: '',//供应商,\n                arrivalCompany: '',\n                arrivalWarehouse: '',\n                pullOrderCode: undefined,//拉料单号\n                deliveriedStartTime: undefined,//送达时间\n                deliveriedEndTime: undefined,\n                pullMaterialType: undefined,//拉料类型\n                queryStateParam: undefined,//拉料状态\n                pullMaterialStatus: 'pull30'\n            },\n            //保存数据\n            saveTemp: {\n                businessType: '',\n                accountDate: this.timeFormat()\n            },\n            saveData: {},\n            sublistQuery: {\n                page: true,\n                currentPage: 1,\n                pageSize: 10,\n                pullOrderCode: undefined//订单号\n            },\n            tableKey: 0,\n            rules: {\n\n            },\n            areaList: null,\n            locatorList: [],\n            locateWarehouseCode: null,\n            isAvaiable: false\n        };\n    },\n    computed: {\n        ...mapState({\n            dt_llrk_transfer_screenGroupNum: state => state.businessComponent.dt_llrk_transfer_screenGroupNum\n        })\n    },\n    mounted () {\n        this.setTableHeight();\n        //表格高度自适应\n        window.onresize = () => {\n            this.setTableHeight()\n        };\n        this.$store.dispatch('businessComponent/getBusinessComponentData', ['dt_llrk_transfer_screenGroupNum']);\n    },\n    methods: {\n        //表格高度计算\n        setTableHeight () {\n            this.theight = this.$myFun.getSingleTbHeight() - 195;\n        },\n        //主表数据获取\n        getListData () {\n            this.listQuery.queryStateParam = this.queryState.join(',');\n            api.queryRecords(this.listQuery).then(res => {\n                res = res.data;\n                this.list = res.list;\n                this.$nextTick(() => {\n                    this.list.forEach((row, index) => {\n                        if (index === 0) {\n                            this.$refs.tbmain.toggleRowSelection(row, true);\n                        }\n                    })\n                })\n            })\n        },\n        //显示主表\n        getList () {\n            this.getListData();\n        },\n        //显示从表\n        getSubList (row) {\n            let params = {\n                queryStateParam: this.listQuery.queryStateParam,\n                orgCode: this.listQuery.arrivalOrgCode,\n                warehouseCode: this.listQuery.warehouseCode,\n                businessType: this.saveTemp.businessType,\n            }\n            api.queryRowRecords(row.pullOrderCode, params).then(res => {\n                res = res.data;\n                this.sublistQuery.pullOrderCode = res[0].pullOrderCode;\n\n                res.forEach((item, index) => {\n                    res[index].sourceRowNo = res[index].rowNo;\n                    res[index].curQuantity = 0;\n                    res[index].invalidQuantity = res[index].pullOrderNum - res[index].receiveOrderNum;\n                })\n\n                for (let i = 0; i < res.length; i++) {\n                    this.locatorList.push([]);\n                }\n                this.listSub = res;\n                api.getArea(this.locateWarehouseCode).then(resa => {\n                    this.areaList = resa.data;\n                })\n            })\n        },\n        timeFormat () {\n            var d = new Date();\n            var year = d.getFullYear();       //年  \n            var month = d.getMonth() + 1;     //月  \n            var day = d.getDate();            //日  \n\n            var clock = year + \"-\";\n            if (month < 10)\n                clock += \"0\";\n            clock += month + \"-\";\n\n            if (day < 10)\n                clock += \"0\";\n            clock += day + \" \";\n            return (clock);\n        },\n        //查询\n        handleQuery () {\n            if (this.listQuery.arrivalOrgCode && this.listQuery.warehouseCode) {\n                this.listRow = [];\n                this.listQuery.currentPage = 1;\n                this.getList();\n            } else {\n                this.$message({\n                    title: this.$t('message.warning'),\n                    message: '请先选择到货单位和到货仓库再进行搜索操作！',\n                    type: \"warning\"\n                });\n            }\n        },\n        //每页大小变化\n        handleSizeChange (val) {\n            this.listQuery.pageSize = val;\n            this.getList();\n        },\n        //当前页变化\n        handleCurrentChange (val) {\n            this.listQuery.currentPage = val;\n            this.getList();\n        },\n        //默认勾选第一行\n        selectDefaultRow (val) {\n            this.selectRows = val;\n            this.locateWarehouseCode = this.selectRows.warehouseCode;\n            this.getSubList(val[val.length - 1]);\n        },\n        //主表勾选框选中\n        selectRow (val) {\n            this.selectRows = val[val.length - 1];\n            if (val.length > 1) {\n                this.$refs.tbmain.clearSelection()\n                this.$refs.tbmain.toggleRowSelection(val[val.length - 1], 'selected')\n            }\n\n            if (val.length !== 0) {\n                this.locateWarehouseCode = this.selectRows.warehouseCode;\n                this.getSubList(val[val.length - 1]);\n            }\n\n            if (val.length == 0) {\n                this.listSub = [];\n            }\n        },\n        //主表点击显示从表\n        showSubTable (val) {\n            this.selectRows = val;\n            this.locateWarehouseCode = val.warehouseCode;\n            this.$refs.tbmain.clearSelection()\n            this.$refs.tbmain.toggleRowSelection(val, 'selected');\n            this.getSubList(val);\n        },\n        selectSubRow (val) {\n            this.selectSubRows = val\n        },\n        //保存\n        handleSave () {\n            if (this.saveTemp.businessType && this.saveTemp.accountDate) {\n                this.$confirm('是否要保存该拉料入库信息', this.$t('message.prompt'), {\n                    confirmButtonText: this.$t('message.confirm'),\n                    cancelButtonText: this.$t('message.cancel'),\n                    type: 'warning'\n                }).then(() => {\n\n                    //save接口\n                    if (this.selectRows.pullOrderCode) {\n                        this.isAvaiable = true;\n                        this.saveData = Object.assign({}, this.selectRows);\n                        this.saveData.sourceOrderNumber = this.saveData.pullOrderCode;\n                        this.saveData.thirdWarehouseCode = this.saveData.thirdPartyWarehouse;\n                        this.saveData.orgCode = this.saveData.arrivalOrgCode\n                        this.saveData.businessType = this.saveTemp.businessType;\n                        this.saveData.accountDate = this.saveTemp.accountDate;\n\n                        this.saveData.receiveOrderItemDTOs = [];\n\n                        this.listSub.forEach((item, index) => {\n                            if (item.curQuantity > 0) {\n                                this.saveData.receiveOrderItemDTOs[index] = Object.assign({}, this.listSub[index])\n                                for (let key in this.saveData.receiveOrderItemDTOs[index]) {\n                                    if (key === 'curQuantity') {\n                                        this.saveData.receiveOrderItemDTOs[index]['receiveQuantity'] = this.saveData.receiveOrderItemDTOs[index][key]\n                                    } else if (key === 'pullOrderCode') {\n                                        this.saveData.receiveOrderItemDTOs[index]['sourceOrderNumber'] = this.saveData.receiveOrderItemDTOs[index][key]\n                                    } else if (key === 'sourceRowNo') {\n                                        this.saveData.receiveOrderItemDTOs[index]['sourceRowNo'] = this.saveData.receiveOrderItemDTOs[index][key]\n                                    } else if (key === 'wareAreaCode') {\n                                        this.saveData.receiveOrderItemDTOs[index]['wareAreaCode'] = this.saveData.receiveOrderItemDTOs[index][key]\n                                    } else if (key === 'wareLocationCode') {\n                                        this.saveData.receiveOrderItemDTOs[index]['wareLocationCode'] = this.saveData.receiveOrderItemDTOs[index][key]\n                                    }\n                                }\n                            }\n                        });\n                        let createList = [];\n                        let isallNull = true;\n                        this.saveData.receiveOrderItemDTOs.forEach((item) => {\n                            if (item.curQuantity > 0) {\n                                createList.push(item);\n                                isallNull = false;\n                            }\n                        });\n                        this.saveData.receiveOrderItemDTOs = createList;\n\n                        if (isallNull) {\n                            this.isAvaiable = false;\n                            this.$message({\n                                title: \"警告\",\n                                message: \"本次入库不可全部为0或空\",\n                                type: \"warning\"\n                            });\n                        } else {\n                            api.createProof(this.saveData).then(() => {\n                                this.setAvaiable(2000);\n                                this.$message({\n                                    type: 'success',\n                                    message: '保存成功'\n                                });\n                                this.getList();\n                                this.$emit('refreshProof')\n                            });\n                            this.setAvaiable(10000);\n                        }\n                    } else {\n                        this.$message({\n                            title: this.$t('message.warning'),\n                            message: '请选择要保存的拉料单',\n                            type: \"warning\"\n                        });\n                    }\n                }).catch(() => {\n                    this.setAvaiable(2000);\n                    this.$message({\n                        type: 'info',\n                        message: this.$t('message.deleteCanceled')\n                    });\n                });\n            } else {\n                this.$message({\n                    title: this.$t('message.warning'),\n                    message: '请先选择业务类型和记账日期',\n                    type: \"warning\"\n                });\n            }\n        },\n        setAvaiable (t) {\n            setTimeout(() => {\n                this.isAvaiable = false;\n            }, t)\n        },\n        //复制\n        handleCopy () {\n            if (this.selectSubRows.length) {\n                this.listSub.map((item, index) => {\n                    this.selectSubRows.forEach((items) => {\n                        if (items.materielCode === item.materielCode) {\n                            this.listSub[index].curQuantity = item.invalidQuantity;\n                            this.$set(this.listSub, index, this.listSub[index]);\n                        }\n                    })\n                })\n            } else {\n                this.$message({\n                    title: this.$t('message.warning'),\n                    message: this.$t('message.checkedplease'),\n                    type: \"warning\"\n                });\n            }\n        },\n\n        setdefault (val, i) {\n            if (i === 1) {\n                this.listQuery.arrivalOrgCode = val;\n            } else if (i === 3) {\n                this.listQuery.warehouseCode = val;\n                this.saveTemp.businessType = this.dt_llrk_transfer_screenGroupNum.options[0].wareRuleCode\n                this.getList();\n            }\n        },\n        getLocatorList (warehouseCode, areaCode, i) {\n            api.getLocator(warehouseCode, areaCode).then(res => {\n                res = res.data;\n                this.$set(this.locatorList, i, res);\n                this.$set(this.listSub[i], 'wareLocationCode', res[0].locationCode);\n                this.$set(this.listSub, i, this.listSub[i]);\n            })\n        },\n        changeAreaSel (areaCode, i) {\n            this.getLocatorList(this.locateWarehouseCode, areaCode, i)\n        },\n        handleRecommend () {\n            if (this.selectRows.warehouseCode && this.saveTemp.businessType && this.selectSubRows.length > 0) {\n                let recommendData = {\n                    businessType: undefined,\n                    orgCode: undefined,\n                    wareMaterielDTOS: [],\n                    warehouseCode: undefined\n                };\n                recommendData.businessType = this.saveTemp.businessType;\n                recommendData.orgCode = this.listQuery.arrivalOrgCode;\n                recommendData.wareMaterielDTOS = this.selectSubRows.map(v => {\n                    let DTOSlist = {}\n                    DTOSlist.materielCode = v.materielCode\n                    DTOSlist.materielClassify = \"\"\n                    return DTOSlist\n                }),\n                    recommendData.warehouseCode = this.listQuery.warehouseCode,\n                    api.recommend(recommendData).then(res => {\n                        res = res.data;\n                        res.forEach((val) => {\n                            this.listSub.forEach((item, index) => {\n                                if (val.materielCode == item.materielCode) {\n\n                                    this.$set(this.listSub[index], 'wareAreaCode', val.areaCode);\n                                    this.$set(this.listSub[index], 'wareLocationCode', val.locationCode);\n                                    this.$set(this.listSub, index, this.listSub[index]);\n                                }\n                            })\n\n                        })\n                    })\n            } else {\n                this.$message({\n                    title: \"警告\",\n                    message: \"请选择拉料主、明细信息及业务类型\",\n                    type: \"warning\"\n                })\n            }\n        },\n        showGys () {\n            this.$emit('showGys', 'register');\n        },\n        setGys (rows) {\n            this.supplierRows = rows;\n            if (!this.supplierRows[0]) {\n                this.$set(this.listQuery, 'supplierCode', \"\");\n                this.$set(this.listQuery, 'supplierName', \"\");\n            } else if (this.supplierRows.length === 1) {\n                this.$set(this.listQuery, 'supplierCode', this.supplierRows[0].supplierCode);\n                this.$set(this.listQuery, 'supplierName', this.supplierRows[0].supplierName);\n            }\n        }\n    }\n}\n",null]}