{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/SRM/procurementDemand/divisionNeeds/divisionRules/dialog/importFile.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/SRM/procurementDemand/divisionNeeds/divisionRules/dialog/importFile.vue","mtime":1603420637349},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport * as importApi from '@/api/import/index'\nimport Pagination from '@/components/Pagination'\n\nexport default {\n    name: 'divisionRulesImport',\n    components: { Pagination },\n    props: ['modalNo'], //模板号\n    data () {\n        return {\n            listData: {\n                title: [],\n                data: []\n            },\n            // 页面表格数据\n            listQuery: null,\n            // 下载模板文件名称\n            excelName: '',\n            modelDetailparI: {\n                excelCode: this.modalNo,\n                currentPage: 0,\n                pageSize: 10\n            },\n            modelDetailpar: {\n                excelCode: this.modalNo,\n                timestamp: null,\n                currentPage: 0,\n                pageSize: 10\n            },\n            total: 0,\n            fileList: [],\n            files: null,\n            uploadurl: '',\n            // 传递的主表的id\n            rowId: undefined\n        }\n    },\n    mounted () { },\n    computed: {\n        myHeader () {\n            return {\n                authToken: window.sessionStorage.getItem('authToken')\n            }\n        },\n    },\n    methods: {\n        // 查询导入的临时数据\n        getUploadData () {\n            let noError = true\n            this.$set(this.modelDetailpar, 'timestamp', (new Date()).getTime())\n            importApi.srmFGGZQueryTempDetail(this.modelDetailpar).then(res => {\n                res = res.data\n                this.listData.data = []\n                res.list.forEach((itemd) => {\n                    this.listData.data.push(itemd)\n                    this.total = res.pages.count\n                    if (itemd.errorMsg && noError) {\n                        noError = false\n                    }\n                })\n\n                if (noError) {\n                    this.$message({\n                        message: '上传成功',\n                        type: 'success'\n                    })\n                } else {\n                    this.$message.error('上传文件内容有误，见表格最后一行，请导出修改正确后重新进行导入操作')\n                }\n            })\n        },\n        // 查询excel模板列表明细\n        getList () {\n            importApi.srmFGGZQueryModelDetail(this.modelDetailparI).then(res => {\n                res = res.data\n                res.list.forEach((item) => {\n                    this.listData.title.push(item)\n                })\n            })\n        },\n        fileExceed () {\n            this.$message.error('一次只能上传一个文件')\n        },\n        beforeUpload (file) {\n            this.files = file\n            const extension = file.name.split('.')[1] === 'xls'\n            const extension2 = file.name.split('.')[1] === 'xlsx'\n            const isLt2M = file.size / 1024 / 1024 < 5\n            if (!extension && !extension2) {\n                this.$message.warning('上传模板只能是 xls、xlsx格式!')\n                return\n            }\n            if (!isLt2M) {\n                this.$message.warning('上传模板大小不能超过 5MB!')\n                return\n            }\n            this.fileName = file.name\n            return false // 返回false不会自动上传\n        },\n        submitUpload () {\n            this.modelDetailpar.timestamp = (new Date()).getTime()\n            if (!this.fileList[0]) {\n                this.$message.warning('请选择要上传的文件！')\n                return false\n            }\n\n            let fileFormData = new FormData()\n            fileFormData.append('file', this.fileList[0])//filename是键，file是值，就是要传的文件，test.zip是要传的文件名\n\n            importApi.srmFGGZUploadExcel(this.modalNo, this.fileList[0], { timestamp: this.modelDetailpar.timestamp, ruleId: this.rowId }).then(res => {\n                if (res.status === 200) {\n                    this.$message.success('上传成功')\n                }\n                this.listData.title.push({ fieldCode: \"errorMsg\", fieldName: \"错误信息\" })\n                this.getUploadData()\n            })\n        },\n        // 自定义上传\n        uploadFile (item) {\n            this.modelDetailpar.timestamp = (new Date()).getTime()\n            const form = new FormData()\n            form.append('file', item.file)\n            let fileFormData = new FormData()\n            fileFormData.append('file', this.fileList[0])\n            importApi.srmFGGZUploadExcel(this.modalNo, fileFormData, { timestamp: this.modelDetailpar.timestamp, ruleId: this.rowId }).then(res => {\n                if (res.status === 200) {\n                    this.$message.success('上传成功')\n                }\n                this.listData.title.push({ fieldCode: \"errorMsg\", fieldName: \"错误信息\" })\n                this.getUploadData()\n            })\n        },\n        handleRemove (file, fileList) {\n            this.fileList = fileList\n        },\n        handleChangeFile (file, fileList) {\n            this.fileList = fileList\n        },\n        //模板下载\n        handleDownload () {\n            importApi.srmPEDownloadModal(this.modalNo).then(res => {\n                this.download(res.data, this.excelName)\n            })\n        },\n        // 下载文件\n        download (data, filename) {\n            if (!data) {\n                return\n            }\n            let url = window.URL.createObjectURL(new Blob([data]))\n            let link = document.createElement('a')\n            link.style.display = 'none'\n            link.href = url\n            link.setAttribute('download', filename)\n\n            document.body.appendChild(link)\n            link.click()\n        },\n        //excel文件导出\n        handleExport () {\n            this.$set(this.listQuery, 'purchaseCode', this.listQuery.orgCode)\n            importApi.srmFGGZDownloadExcel(this.modalNo, this.listQuery ).then(res => {\n                let filename = decodeURI(res.headers['content-disposition'].split(';')[1].split('=')[1]) || 'excel.xlsx'\n                this.download(res.data, filename)\n            })\n        }\n    }\n}\n",null]}