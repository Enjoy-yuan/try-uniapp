{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/WMS/knProcessing/jhknProcessing/content/contentRegister.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/WMS/knProcessing/jhknProcessing/content/contentRegister.vue","mtime":1596610934125},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport * as api from \"@/api/project/wms/knProcessing/knjgplan\";\n// import wlxz from '@/components/Select/wlxz'//物料信息模块\nimport { mapState } from 'vuex';\nimport AuthoType from '@/components/Select/AuthoType.vue'//权限类型下拉组件\n\nexport default {\n    name: \"contentRegister\",\n    components: { AuthoType },\n    data () {\n        return {\n            rheight: 0,\n            list: null,\n            listSub: null,\n            executionStatusArr: ['0', '1'],\n            listQuery: {\n                orgCode: undefined,\n                warehouseCode: undefined,\n                dicType: undefined,\n                accountDate: this.timeFormat(),\n                planNo: undefined,\n                planDate: undefined,\n                executionStatus: undefined\n            },\n            totalsub: 0,\n            total: 0,\n            curRow: null,\n            selectRows: [],\n            wlxzDialogFormVisible: false,\n            wlxzRows: [],\n            rules: {\n                orgCode: [\n                    { required: true, message: ' ', trigger: 'blur' }\n                ],\n                warehouseCode: [\n                    { required: true, message: ' ', trigger: 'blur' }\n                ],\n                dicType: [\n                    { required: true, message: ' ', trigger: 'blur' }\n                ],\n                accountDate: [\n                    { required: true, message: ' ', trigger: 'blur' }\n                ]\n            },\n            defaultStockType: undefined,\n            defaultStockStatus: undefined,\n            defaultStockTypeSub: undefined,\n            defaultStockStatusSub: undefined,\n            areaList: null,\n            locatorList: [],\n            locatorListD: [],\n            saveData: {},//保存的数据\n            businessTypeList: [],\n            configBusiness: {\n                db: '0908',\n                cz: '0902',\n                zz: '0901'\n            },\n            isEdit: false,\n            isSaveEdit: false\n        };\n    },\n    computed: {\n        ...mapState({\n            dt_stock_type: state => state.dict.dt_stock_type,\n            dt_stock_status: state => state.dict.dt_stock_status\n        })\n    },\n    mounted () {\n        this.setTableHeight();\n        this.$store.dispatch('dict/getDicData', ['dt_stock_type', 'dt_stock_status']);\n    },\n    methods: {\n        //表格高度计算\n        setTableHeight () {\n            this.rheight = this.$myFun.getSingleTbHeight() - 110;\n        },\n        timeFormat () {\n            var d = new Date();\n            var year = d.getFullYear();       //年  \n            var month = d.getMonth() + 1;     //月  \n            var day = d.getDate();            //日  \n\n            var clock = year + \"-\";\n            if (month < 10)\n                clock += \"0\";\n            clock += month + \"-\";\n\n            if (day < 10)\n                clock += \"0\";\n            clock += day + \" \";\n            return (clock);\n        },\n        getList () {\n            let queryData = {\n                page: true,\n                currentPage: 1,\n                pageSize: 10,\n                method: 'executions',\n                orgCode: this.listQuery.orgCode,\n                warehouseCode: this.listQuery.warehouseCode,\n                dicType: this.listQuery.dicType,\n                planNo: this.listQuery.planNo,\n                planDate: this.listQuery.planDate,\n                executionStatus: this.executionStatusArr.join(','),\n                state: 1\n            };\n            this.listSub = []\n            api.queryRecordsDetail(queryData).then(res => {\n                this.list = res.data.list;\n                this.total = res.data.pages.count;\n                api.getArea(this.listQuery.warehouseCode).then(resa => {\n                    this.areaList = resa.data;\n                    this.setDefaultTable()\n                })\n            });\n        },\n        getSubList (val) {\n            let versions = val.versions;\n            api.getKlDetail(versions).then(res => {\n                this.listSub = res.data;\n                this.setDefaultSub()\n                this.calculateNum(this.selectRows.quantity)\n            })\n        },\n        //主表勾选框选中\n        selectRow (val) {\n            console.log(val, 'val')\n            this.selectRows = val[val.length - 1];\n            if (val.length > 1) {\n                this.$refs.tbmain.clearSelection()\n                this.$refs.tbmain.toggleRowSelection(val[val.length - 1], 'selected')\n            }\n\n            if (val.length !== 0) {\n                this.getSubList(val[val.length - 1]);\n            }\n        },\n        rowClick (row) {\n            // this.curRow = row\n            this.$refs.tbmain.toggleRowSelection(row, true)\n        },\n        setdefault (val, i) {\n            if (i === 1) {\n                this.listQuery.orgCode = val;\n            } else if (i === 3) {\n                this.listQuery.warehouseCode = val;\n            }\n        },\n        getLocatorList (warehouseCode, areaCode, i) {\n            api.getLocator(warehouseCode, areaCode).then(res => {\n                this.$set(this.locatorList, i, res.data);\n                this.list[i].wareLocationCode = this.locatorList[i][0].locationCode\n                this.$set(this.list, i, this.list[i])\n            })\n        },\n        getLocatorListD (warehouseCode, areaCode, i) {\n            api.getLocator(warehouseCode, areaCode).then(res => {\n                this.$set(this.locatorListD, i, res.data);\n                this.listSub[i].wareLocationCode = this.locatorListD[i][0].locationCode\n                this.$set(this.listSub, i, this.listSub[i])\n            })\n        },\n        changeAreaSel (areaCode, i) {\n            this.getLocatorList(this.listQuery.warehouseCode, areaCode, i)\n        },\n        changeAreaSelD (areaCode, i) {\n            this.getLocatorListD(this.listQuery.warehouseCode, areaCode, i)\n        },\n        //查询\n        handleQuery () {\n            if (!this.listQuery.orgCode || !this.listQuery.warehouseCode || !this.listQuery.dicType) {\n                this.$message({\n                    title: this.$t(\"message.warning\"),\n                    message: '请先选择组织编码,仓库编码及业务类型再搜索',\n                    type: \"warning\"\n                });\n            } else {\n                api.queryStock(this.listQuery.dicType).then(res => {\n                    this.defaultStockType = res.data.list[0].fetchStockType.split(\",\")[0]\n                    this.defaultStockStatus = res.data.list[0].fetchStockStat.split(\",\")[0]\n                    if (res.data.list[0].completedLink) {\n                        api.queryStock(res.data.list[0].completedLink).then(resa => {\n                            this.defaultStockTypeSub = resa.data.list[0].fetchStockType.split(\",\")[0]\n                            this.defaultStockStatusSub = resa.data.list[0].fetchStockStat.split(\",\")[0]\n                            this.isEdit = true;\n                            this.getList();\n                        })\n                    } else {\n                        this.defaultStockTypeSub = this.defaultStockType\n                        this.defaultStockStatusSub = this.defaultStockStatus\n                        this.isEdit = true;\n                        this.getList();\n                    }\n\n                })\n\n            }\n        },\n        //保存\n        handleSave () {\n            if (this.selectRows) {\n                if (this.selectRows.length === 0) {\n                    this.$message({\n                        title: this.$t(\"message.warning\"),\n                        message: '请先选择一条主数据',\n                        type: \"warning\"\n                    });\n                } else {\n                    let saveable = true\n                    this.list.forEach(item => {\n                        if (item.quantity > item.unexecutedNum) {\n                            saveable = false\n                        }\n                    })\n                    if (!saveable) {\n                        this.$message({\n                            title: this.$t(\"message.warning\"),\n                            message: '本次完工不能大于待完工，请检查后再保存',\n                            type: \"warning\"\n                        });\n                    } else if (!this.listQuery.accountDate) {\n                        this.$message({\n                            title: this.$t(\"message.warning\"),\n                            message: '记账日期不能为空',\n                            type: \"warning\"\n                        });\n                    } else {\n                        this.$refs.listQuery.validate((valid) => {\n                            if (valid) {\n                                let saveData = {\n                                    orgCode: '',\n                                    warehouseCode: '',\n                                    dicType: '',\n                                    relationDicType: '',\n                                    accountDate: '',\n                                    processingAssemblyDTO: {},\n                                    assemblyDetailDTOSs: [],\n                                    planNo: this.selectRows.planNo,\n                                    planRowNo: this.selectRows.rowNo\n                                }\n                                for (let key in this.listQuery) {\n                                    if (key === 'orgCode' || key === 'warehouseCode' || key === 'dicType' || key === 'relationDicType' || key === 'accountDate') {\n                                        saveData[key] = this.listQuery[key]\n                                    }\n                                }\n                                for (let key in this.selectRows) {\n                                    if (key === 'materielCode' || key === 'materielName' || key === 'measuringUnit' || key === 'quantity' || key === 'stockState' || key === 'stockType' || key === 'wareAreaCode' || key === 'wareLocationCode') {\n                                        saveData.processingAssemblyDTO[key] = this.selectRows[key];\n                                    }\n                                    if (key === 'stockStateArr') {\n                                        saveData.processingAssemblyDTO['stockState'] = this.selectRows.stockStateArr.join(',');\n                                    }\n                                    if (key === 'stockTypeArr') {\n                                        saveData.assemblyDetailDTOSs['stockType'] = this.selectRows.stockTypeArr.join(',');\n                                    }\n                                }\n                                if (this.listSub) {\n                                    this.listSub.forEach((item, index) => {\n                                        saveData.assemblyDetailDTOSs.push({});\n                                        for (let key in item) {\n                                            if (key === 'materielCode' || key === 'materielName' || key === 'measuringUnit' || key === 'quantity' || key === 'stockState' || key === 'stockType' || key === 'wareAreaCode' || key === 'wareLocationCode') {\n                                                saveData.assemblyDetailDTOSs[index][key] = item[key];\n                                            }\n                                            if (key === 'stockStateArr') {\n                                                saveData.assemblyDetailDTOSs[index]['stockState'] = item.stockStateArr.join(',');\n                                            }\n                                            if (key === 'stockTypeArr') {\n                                                saveData.assemblyDetailDTOSs[index]['stockType'] = item.stockTypeArr.join(',');\n                                            }\n                                        }\n                                    });\n\n                                    this.$confirm('确认保存吗?', '提示', {\n                                        confirmButtonText: '确定',\n                                        cancelButtonText: '取消',\n                                        type: 'warning'\n                                    }).then(() => {\n                                        this.isSaveEdit = true;\n                                        api.createProof(saveData).then(() => {\n                                            this.$message({\n                                                type: 'success',\n                                                message: '保存成功'\n                                            });\n                                        })\n                                    });\n                                } else {\n                                    this.$message({\n                                        title: this.$t(\"message.warning\"),\n                                        message: '请先选择有计划号的加工数据',\n                                        type: \"warning\"\n                                    });\n                                }\n\n                            } else {\n                                this.$message({\n                                    title: this.$t(\"message.warning\"),\n                                    message: '请先填写及选择必填项',\n                                    type: \"warning\"\n                                });\n                            }\n                        })\n                    }\n                }\n            } else {\n                this.$message({\n                    title: this.$t(\"message.warning\"),\n                    message: '请先选择一条主数据',\n                    type: \"warning\"\n                });\n            }\n        },\n        //业务类型相关值操作\n        setdicTypeRelated (val) {\n            this.businessTypeList.options.forEach((item) => {\n                if (item.wareRuleCode === val) {\n                    this.listQuery.relationDicType = item.completedLink;\n                    if (this.listQuery.dicType === this.configBusiness.cz) {\n                        this.listQuery.stockState = item.fetchStockStat;\n                        this.listQuery.stockType = item.fetchStockType;\n                    } else {\n                        this.listQuery.stockState = item.storeStockStat;\n                        this.listQuery.stockType = item.storeStockType;\n                    }\n                }\n            })\n        },\n        //刷新\n        handleRefresh () {\n            this.isEdit = false;\n            this.isSaveEdit = false;\n            this.list = [];\n            this.listSub = [];\n        },\n        calculateNum (quantity) {\n            if (quantity) {\n                if (this.listQuery.dicType === this.configBusiness.zz) {\n                    this.listSub.map((item, index) => {\n                        this.$set(this.listSub[index], 'quantity', parseFloat(item.assemblingNum) * parseFloat(quantity))\n                    })\n                }\n                if (this.listQuery.dicType === this.configBusiness.cz) {\n                    this.listSub.map((item, index) => {\n                        this.$set(this.listSub[index], 'quantity', parseFloat(item.dismantlingNum) * parseFloat(quantity))\n                    })\n                }\n            }\n        },\n        setDefaultTable () {\n            this.list.forEach((item, index) => {\n                if (this.listQuery.dicType === this.configBusiness.cz) {\n                    this.$set(this.list[index], 'stockTypeArr', [this.defaultStockType])\n                    this.$set(this.list[index], 'stockStateArr', [this.defaultStockStatus])\n                } else {\n                    this.$set(this.list[index], 'stockType', this.defaultStockType)\n                    this.$set(this.list[index], 'stockState', this.defaultStockStatus)\n                }\n\n                this.list[index].wareAreaCode = this.areaList[0].areaCode\n                this.changeAreaSel(this.areaList[0].areaCode, index)\n            })\n        },\n        setDefaultSub () {\n            this.listSub.forEach((item, index) => {\n                if (this.listQuery.dicType === this.configBusiness.cz) {\n                    this.$set(this.listSub[index], 'stockTypeArr', [this.defaultStockTypeSub])\n                    this.$set(this.listSub[index], 'stockStateArr', [this.defaultStockStatusSub])\n                } else {\n                    this.$set(this.listSub[index], 'stockType', this.defaultStockTypeSub)\n                    this.$set(this.listSub[index], 'stockState', this.defaultStockStatusSub)\n                }\n                this.listSub[index].wareAreaCode = this.areaList[0].areaCode\n                this.changeAreaSelD(this.areaList[0].areaCode, index)\n            })\n        }\n    }\n}\n",null]}