{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/SRM/priceManage/priceApproval/priceApprovalList/content/formation.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/SRM/priceManage/priceApproval/priceApprovalList/content/formation.vue","mtime":1596610933687},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport * as api from \"@/api/project/srm/priceManage/priceApprovalList\"\nimport { DICT_CODE } from '@/utils/constant'\nimport caiGou from '@/components/Select/xtpt/caigou'//下拉组件\nimport { mapState } from \"vuex\"\nimport addMain from '../dialog/addMain'//下拉组件\nimport dialogGysxz from '@/components/Dialog/dialogsGysxz'//供应商选择\nimport dialogPriceConfirm from '@/components/Dialog/dialogPriceConfirm.vue'//物料选择\nimport dialogReduction from '@/components/Dialog/dialogReduction.vue'//物料选择\nimport dialogActuarial from '@/components/Dialog/dialogActuarial.vue'//物料选择\nexport default {\n    components: { addMain, caiGou, dialogGysxz, dialogPriceConfirm, dialogReduction, dialogActuarial },\n    data () {\n        return {\n            Edit: false,\n            status: null,\n            type: null,\n            DICT_CODE: DICT_CODE,\n            temp: {\n                rowId: undefined,\n                orgCode: undefined,\n                orgName: undefined,\n                approvalType: undefined,\n                supplierCode: undefined,\n                supplierName: undefined,\n                years: undefined,\n                settlementMethod: undefined,\n                remark: undefined\n            },\n            list: [],\n            rules: {\n                orgCode: [{ required: true, message: '组织编码不能为空', trigger: 'blur' }],\n                approvalType: [{ required: true, message: '审批类型不能为空', trigger: 'blur' }],\n                supplierCode: [{ required: true, message: '供应商编码不能为空', trigger: 'blur' }],\n                years: [{ required: true, message: '年度不能为空', trigger: 'blur' }],\n            }\n        }\n    },\n    computed: {\n        ...mapState({\n            dt_unit_type: state => state.dict.dt_unit_type,\n            dt_srm_pc8: state => state.dict.dt_srm_pc8,\n            dt_srm_pdt: state => state.dict.dt_srm_pdt,\n            dt_srm_pc9: state => state.dict.dt_srm_pc9,\n            dt_srm_pc6: state => state.dict.dt_srm_pc6,\n        })\n    },\n    mounted () {\n        this.$store.dispatch(\"dict/getDicData\", ['dt_srm_pc8', 'dt_srm_pdt', 'dt_srm_pc9', 'dt_srm_pc6', 'dt_unit_type'])\n    },\n    methods: {\n        initForm (status, val) {\n            console.log(status, val, 'kkkk')\n            this.$refs['dataForm'].resetFields()\n            this.$refs['dataForm'].clearValidate()\n            this.status = status\n            if (status == 'update') {\n                // this.temp = val\n                for (let key in this.temp) {\n                    for (let par in val) {\n                        if (key === par) {\n                            this.$set(this.temp, key, val[key])\n                        }\n                    }\n                }\n                let options = [this.dt_srm_pc6]\n                val.approvalItemDTOS = this.$myFun.srmCodeToName(val.approvalItemDTOS, options, ['dataSource'])\n                this.list = val.approvalItemDTOS\n                console.log(this.list, 'this.list')\n                this.Edit = true //编辑得时候置灰\n            } else {\n                this.Edit = false\n                this.list = []\n            }\n        },\n        newData (val) {\n            this.list.forEach((itemd, index) => {\n                if (itemd.associatedOrderNo === val.associatedOrderNo) {\n                    this.list[index] = val\n                    this.$set(this.list, index, this.list[index])\n                } else {\n                    return\n                }\n            })\n        },\n        //获取组织编码名称\n        selectName (val) {\n            this.temp.orgName = val\n        },\n        //类型变更\n        changeType () {\n            this.list = []\n        },\n        //供应商\n        showGys () {\n            this.$refs.refGys.dialogVisible = true\n            this.$refs.refGys.getList()\n        },\n        //供应商确定\n        handleGysClick (val) {\n            this.$set(this.temp, 'supplierCode', val[0].supplierCode)\n            this.$set(this.temp, 'supplierName', val[0].supplierName)\n        },\n        handleCreate () {\n            if (this.temp.orgName && this.temp.approvalType && this.temp.supplierCode && this.temp.years) {\n                if (this.temp.approvalType == 'PC80') {\n                    this.type = 'PC60'\n                    this.$refs.wlxz.dialogVisible = true\n                    this.$nextTick(() => {\n                        this.$refs.wlxz.listSelected = [...this.list]\n                        this.$refs.wlxz.getList()\n                    })\n                } else if (this.temp.approvalType == 'PC81') {\n                    this.type = 'PC61'\n                    this.$refs.jbh.dialogVisible = true\n                    this.$nextTick(() => {\n                        this.$refs.jbh.listSelected = [...this.list]\n                        this.$refs.jbh.getList()\n                    })\n                } else {\n                    this.type = 'PC62'\n                    this.$refs.actuarial.dialogVisible = true\n                    this.$nextTick(() => {\n                        this.$refs.actuarial.listSelected = [...this.list]\n                        this.$refs.actuarial.getList()\n                    })\n                }\n            } else {\n                this.$message({\n                    title: \"警告\",\n                    message: \"请先选择组织，审批类型，供应商，年度\",\n                    type: \"warning\"\n                })\n            }\n        },\n        //价格确认单\n        confirmWlxz (val) {\n            val = JSON.parse(JSON.stringify(val))\n            this.list = val.map(v => {\n                v.associatedOrderNo = v.confirmationNo\n                v.baseUnit = v.baseMeasureUnit\n                v.measureUnit = v.purchaseMeasureUnit\n                v.dataSource = this.type\n                v.approvalPrice = v.confirmPrice\n                return v\n            })\n            console.log(this.list, ' this.list')\n            let options = [this.dt_unit_type, this.dt_unit_type, this.dt_srm_pc6]\n            this.list = this.$myFun.codeToName(this.list, options, ['baseUnit', 'measureUnit', 'dataSource'])\n        },\n        //降本函维护\n        confirmReduction (val) {\n            this.list = val.map(v => {\n                v.associatedOrderNo = v.costReductionNo\n                v.baseUnit = v.baseMeasureUnit\n                v.measureUnit = v.purchaseMeasureUnit\n                v.dataSource = this.type\n                return v\n            })\n            let options = [this.dt_unit_type, this.dt_unit_type, this.dt_srm_pc6]\n            this.list = this.$myFun.codeToName(this.list, options, ['baseUnit', 'measureUnit', 'dataSource'])\n        },\n        //零件成本精算\n        confirmActuarial (val) {\n            console.log(val, 'val')\n            this.list = val.map(v => {\n                v.associatedOrderNo = v.actuarialNo\n                v.baseUnit = v.baseMeasureUnit\n                v.measureUnit = v.purchaseMeasureUnit\n                v.dataSource = this.type\n                v.confirmPrice = v.actuarialPrice\n                return v\n            })\n            let options = [this.dt_unit_type, this.dt_unit_type, this.dt_srm_pc6]\n            this.list = this.$myFun.codeToName(this.list, options, ['baseUnit', 'measureUnit', 'dataSource'])\n\n        },\n        handleUpdate (index, val) {\n            this.$refs.addMain.dialogStatus = 'update'\n            this.$refs.addMain.dialogVisible = true\n            this.$refs.addMain.temp = { ...val }\n        },\n        handleClose () {\n            this.$emit('changeState', 'approval')\n        },\n        //保存按钮单击事件\n        handleSave () {\n            this.$refs.dataForm.validate(valid => {\n                if (valid) {\n                    if (this.status == 'create') {\n                        let limitState = this.list.every(v => {\n                            return v.approvalPrice && v.priceType && v.validTimeStart && v.validTimeEnd\n                        })\n                        if (limitState) {\n                            let dto = {\n                                approvalType: this.temp.approvalType,\n                                orgCode: this.temp.orgCode,\n                                orgName: this.temp.orgName,\n                                remark: this.temp.remark,\n                                settlementMethod: this.temp.settlementMethod,\n                                supplierCode: this.temp.supplierCode,\n                                supplierName: this.temp.supplierName,\n                                years: this.temp.years,\n                                approvalItemDTOS: this.list\n                            }\n                            api.createRecords(dto).then(() => {\n                                this.$message({\n                                    title: '成功',\n                                    message: '新增成功',\n                                    type: 'success',\n                                    duration: 2000\n                                })\n                                this.$emit('changeState', 'approval')\n                                this.$emit('refresh')\n                            })\n                        } else {\n                            this.$message({\n                                title: \"警告\",\n                                message: \"请填写审批价格，价格类别代码，价格生效日期，价格失效日期\",\n                                type: \"warning\"\n                            })\n                        }\n                    } else {\n                        let limitState = this.list.every(v => {\n                            return v.approvalPrice && v.priceType && v.validTimeStart && v.validTimeEnd\n                        })\n                        if (limitState) {\n                            let dto = {\n                                approvalType: this.temp.approvalType,\n                                orgCode: this.temp.orgCode,\n                                orgName: this.temp.orgName,\n                                remark: this.temp.remark,\n                                settlementMethod: this.temp.settlementMethod,\n                                supplierCode: this.temp.supplierCode,\n                                supplierName: this.temp.supplierName,\n                                years: this.temp.years,\n                                approvalItemDTOS: this.list\n                            }\n                            api.updateRecords(this.temp.rowId, dto).then(() => {\n                                this.$message({\n                                    title: '成功',\n                                    message: '编辑成功',\n                                    type: 'success',\n                                    duration: 2000\n                                })\n                                this.$emit('changeState', 'approval')\n                                this.$emit('refresh')\n                            })\n                        } else {\n                            this.$message({\n                                title: \"警告\",\n                                message: \"请填写审批价格，价格类别代码，价格生效日期，价格失效日期\",\n                                type: \"warning\"\n                            })\n                        }\n\n                    }\n                } else {\n                    return false\n                }\n            })\n        },\n        //表格操作删除\n        handleDelete (index, row) {\n            console.log('删除', index, row)\n            this.$confirm('确认要删除该数据项吗?', '提示', {\n                confirmButtonText: '确定',\n                cancelButtonText: '取消',\n                type: 'warning'\n            }).then(() => {\n                this.list = this.list.filter(item => {\n                    let isD = true\n                    if (row.rowId === item.rowId) {\n                        isD = false\n                    }\n                    return isD\n                })\n\n                this.$message({\n                    type: 'success',\n                    message: '删除成功'\n                })\n            }).catch(() => {\n                this.$message({\n                    type: 'info',\n                    message: '已取消'\n                })\n            })\n        },\n    }\n}\n",null]}