{"remainingRequest":"/Users/yuan/Documents/大唐广电/cf_web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/cf_web/src/views/project/IOT/IOT/IOTIA/components/equipment.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/cf_web/src/views/project/IOT/IOT/IOTIA/components/equipment.vue","mtime":1600927611490},{"path":"/Users/yuan/Documents/大唐广电/cf_web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/cf_web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/cf_web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/cf_web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n// import Pagination from '@/components/Pagination'\nimport * as api from '@/api/project/iot/IOT/ia.js'\nimport { queryProjects } from '@/api/project/iot/IOT/project'\nimport { mapState } from 'vuex'\nimport throttle from 'lodash/throttle'\nimport clip from '@/utils/clipboard'\n\nexport default {\n    name: 'equipment',\n    // components: { Pagination },\n    data() {\n        return {\n            treeData: [], // 树型菜单\n            theight: 0, // 表格⾼度\n            titleName: '', // 点击的标题名\n            listQuery: {\n                currentPage: 1,\n                pageSize: 15,\n                method: 'NO'\n            },\n            tableData: [], // 表格数据\n            total: 0, // 总条数\n            listLoading: false, // 表格加载动画\n            defaultProps: {\n                // 树型结构属性\n                children: 'children',\n                label: 'name'\n            },\n            contentStyleObj: {\n                // 树型⾼度\n                height: ''\n            },\n            treeRowId: [], // 默认展开的菜单\n            projectCode: '', // 项⽬代码编号\n            projectList: [], // 项⽬数组\n            deviceCode: '', // 菜单点击编码\n            normCode: '', // 表格行编号\n            rowData: '', // 点击当前行数据\n            dialogFormVisible: false, // 弹框是否显示\n            dialogFormVisible2: false, // 粒度设置弹框\n            dialogFormVisible3: false, // 公式编辑弹框\n            temp: {\n                // 弹框输入框数据\n                normName: '',\n                normCode: '',\n                company: '',\n                indexDescription: ''\n            },\n            // 第二个弹框数据\n            temp2: {\n                minuteFifteen: '',\n                minuteThirty: '',\n                hour: '',\n                day: '',\n                month: '',\n                year: '',\n                dayDetail: '',\n                monthDetail: ''\n            },\n            // 第三个弹框数据\n            temp3: {\n                name: '',\n                point: '',\n                nameplate: ''\n            },\n            rowFormula: {}, // 点击行的数据\n            inputFormula: '', // 公式\n            deviceNames: [], // 公式编辑，设备名称数组\n            devicePoints: [], // 公式编辑，设备点位数组\n            deviceNameplates: [], // 公式编辑，设备铭牌数组\n            copyDevicePoints: [], // 复制的设备点位数组\n            copyDeviceNameplates: [], // 复制的设备铭牌数组\n            days: [], // 时间数组\n            months: [], // 日期数组\n            rules: {\n                // 规则校验\n                normName: [\n                    {\n                        required: true,\n                        message: '请输入指标名称',\n                        trigger: 'blur'\n                    }\n                ],\n                normCode: [\n                    {\n                        required: true,\n                        message: '请输入指标编码',\n                        trigger: 'blur'\n                    }\n                ],\n                company: [\n                    {\n                        required: true,\n                        message: '请输入单位',\n                        trigger: 'blur'\n                    }\n                ]\n            }\n        }\n    },\n    computed: {\n        ...mapState({\n            iot_is_standard: (state) => state.iotDict.iot_is_standard,\n            iot_norm_company: (state) => state.iotDict.iot_norm_company\n        }),\n        inputFormulaCode() {\n            let temp = this.inputFormula\n\n            if (this.copyDevicePoints.length > 0 && temp) {\n                this.copyDevicePoints.map((item) => {\n                    temp = temp.replace(new RegExp(item.attributeName, 'g'), item.attributeCode)\n                })\n            }\n            if (this.copyDeviceNameplates.length > 0 && temp) {\n                this.copyDeviceNameplates.map((item) => {\n                    this.deviceNames.map((childItem) => {\n                        temp = temp.replace(eval('/\\\\[' + childItem.deviceName + '.' + item.tagName + '\\\\]/g'), item.tagValue)\n                    })\n                })\n            }\n            if (this.deviceNames.length > 0 && temp) {\n                this.deviceNames.map((item) => {\n                    temp = temp.replace(new RegExp(item.deviceName, 'g'), item.gatewayCode + '.' + item.deviceCode)\n                })\n            }\n            return temp\n        }\n    },\n    watch: {\n        '$route.params': {\n            immediate: true,\n            handler: function(newval) {\n                if (newval && newval.code) {\n                    // 在code变化时才重新请求\n                    queryProjects().then((res) => {\n                        this.projectList = res.data\n                        this.projectCode = newval.code\n                        this.getTreeData()\n                    })\n                } else if (!this.projectCode) {\n                    // 不存在projectCode则取接⼝返回的第⼀个projectCode\n                    queryProjects().then((res) => {\n                        this.projectList = res.data\n                        this.projectCode = res.data[0].projectCode\n                        this.getTreeData()\n                    })\n                }\n            }\n        }\n    },\n    mounted() {\n        // 循环造数据\n        for (let i = 1; i <= 24; i++) {\n            this.days.push(i + '时')\n        }\n        for (let i = 1; i <= 31; i++) {\n            this.months.push(i + '号')\n        }\n        this.$store.dispatch('iotDict/getDicData', ['iot_is_standard', 'iot_norm_company'])\n        this.setTableHeight()\n        //表格⾼度⾃适应\n        window.onresize = () => {\n            this.setTableHeight()\n        }\n    },\n    methods: {\n        // 清空数据并打开自定义指标弹框\n        openDialog() {\n            this.temp = {\n                normName: '',\n                normCode: '',\n                company: '',\n                indexDescription: ''\n            }\n            this.dialogFormVisible = true\n        },\n        // 关闭自定义指标弹框\n        closeDialog() {\n            this.dialogFormVisible = false\n        },\n        // 清空数据，打开粒度弹框\n        openDialogGranularity(index, row) {\n            this.temp2 = {\n                minuteFifteen: '',\n                minuteThirty: '',\n                hour: '',\n                day: '',\n                month: '',\n                year: '',\n                dayDetail: '',\n                monthDetail: ''\n            }\n            this.normCode = row.normCode\n            this.rowData = row\n            if (row.dateDefinition) {\n                this.temp2.day = '自定义'\n                this.temp2.dayDetail = row.dateDefinition.split('-')[0]\n            }\n            if (row.monthDefinition) {\n                this.temp2.day = '自定义'\n                this.temp2.dayDetail = row.monthDefinition.split('-')[0]\n            }\n            if (this.rowData.calculationGranularity) {\n                this.rowData.calculationGranularity.split(',').map((item) => {\n                    if (item === '15min') {\n                        this.temp2.minuteFifteen = true\n                    }\n                    if (item === '30min') {\n                        this.temp2.minuteThirty = true\n                    }\n                    if (item === '1h') {\n                        this.temp2.hour = true\n                    }\n                    if (item === '1d') {\n                        this.temp2.day = '自然天'\n                    }\n                    if (item === '1month') {\n                        this.temp2.month = '自然月'\n                    }\n                    if (item === '1y') {\n                        this.temp2.year = true\n                    }\n                })\n            }\n            this.dialogFormVisible2 = true\n        },\n        // 清空数据，打开公式编辑\n        openDialogFormula(index, row) {\n            this.rowFormula = row\n            // 清空数据\n            this.temp3 = {\n                name: '',\n                point: '',\n                nameplate: ''\n            }\n            this.inputFormula = row.formula\n            if (row.pointArray) {\n                this.copyDevicePoints = JSON.parse(row.pointArray)\n            }\n            if (row.nameplateArray) {\n                this.copyDeviceNameplates = JSON.parse(row.nameplateArray)\n            }\n            this.devicePoints = []\n            this.deviceNames = []\n            this.deviceNameplates = []\n            api.getDeviceByProjectCode(row.projectCode).then((res) => {\n                this.deviceNames = res.data\n            })\n\n            this.dialogFormVisible3 = true\n        },\n        // 关闭公式编辑弹框\n        closeDialogFormula() {\n            this.dialogFormVisible3 = false\n        },\n        //改变设备名称\n        changeName(deviceCode) {\n            // 清空数据\n            this.temp3.point = ''\n            this.devicePoints = []\n            this.temp3.nameplate = ''\n            this.deviceNameplates = []\n            api.getCollect(this.rowFormula.projectCode, deviceCode).then((res) => {\n                this.devicePoints = res.data\n            })\n            api.getNamelpate(this.rowFormula.projectCode, deviceCode).then((res) => {\n                res.data.map((item) => {\n                    if (item.tagValue) {\n                        item.value = item.tagName + '(' + item.company + ')'\n                        this.deviceNameplates.push(item)\n                    }\n                })\n            })\n        },\n        // 复制点位\n        copyPoint(event) {\n            let formula = ''\n            if (this.temp3.name === '') {\n                this.$message({\n                    message: '请先选择设备名称',\n                    type: 'warning',\n                    duration: 1500\n                })\n            } else if (this.temp3.point === '') {\n                this.$message({\n                    message: '请先选择设备点位',\n                    type: 'warning',\n                    duration: 1500\n                })\n            } else {\n                this.deviceNames.map((item) => {\n                    if (item.deviceCode === this.temp3.name) {\n                        formula = '[' + item.deviceName + '.'\n                    }\n                })\n                this.devicePoints.map((item) => {\n                    if (item.attributeCode === this.temp3.point) {\n                        formula += item.attributeName + ']'\n                        this.copyDevicePoints.push({\n                            attributeCode: item.attributeCode,\n                            attributeName: item.attributeName\n                        })\n                    }\n                })\n                clip(formula, event)\n            }\n        },\n        // 复制铭牌\n        copyNameplate() {\n            let formula = ''\n            if (this.temp3.name === '') {\n                this.$message({\n                    message: '请先选择设备名称',\n                    type: 'warning',\n                    duration: 1500\n                })\n            } else {\n                if (this.temp3.nameplate === '') {\n                    this.$message({\n                        message: '请先选择设备铭牌',\n                        type: 'warning',\n                        duration: 1500\n                    })\n                } else {\n                    this.deviceNames.map((item) => {\n                        if (item.deviceCode === this.temp3.name) {\n                            formula = '[' + item.deviceName + '.'\n                        }\n                    })\n                    this.deviceNameplates.map((item) => {\n                        if (item.tagValue === this.temp3.nameplate) {\n                            formula += item.tagName + ']'\n                            this.copyDeviceNameplates.push({\n                                tagValue: item.tagValue,\n                                tagName: item.tagName\n                            })\n                        }\n                    })\n                    clip(formula, event)\n                }\n            }\n        },\n        // 关闭粒度设置弹框\n        closeDialogGranularity() {\n            this.dialogFormVisible2 = false\n        },\n        // 保存公式\n        saveFormula() {\n            let pointArray = []\n            let nameplateArray = []\n            this.copyDevicePoints.map((item) => {\n                if (this.inputFormula.indexOf(item.attributeName) !== -1) {\n                    pointArray.push({\n                        attributeName: item.attributeName,\n                        attributeCode: item.attributeCode\n                    })\n                }\n            })\n            this.copyDeviceNameplates.map((item) => {\n                if (this.inputFormula.indexOf(item.tagName) !== -1) {\n                    nameplateArray.push({\n                        tagName: item.tagName,\n                        tagValue: item.tagValue\n                    })\n                }\n            })\n\n            api.patchFormula(this.rowFormula.projectCode, this.rowFormula.deviceCode, this.rowFormula.normCode, {\n                formula: this.inputFormula,\n                formulaPreview: this.inputFormulaCode,\n                pointArray: JSON.stringify(pointArray),\n                nameplateArray: JSON.stringify(nameplateArray)\n            },{\n                method: 'NO'\n            }).then(() => {\n                this.$message({\n                    message: '编辑成功',\n                    type: 'success',\n                    duration: 1500\n                })\n                this.getList()\n                this.closeDialogFormula()\n            })\n        },\n        // 粒度设置\n        createGranularity() {\n            if (this.temp2.day === '自定义' && this.temp2.dayDetail === '') {\n                this.$message.error('请选择天级自定义时间')\n            } else if (this.temp2.month === '自定义' && this.temp2.monthDetail === '') {\n                this.$message.error('请选择月级自定义月份')\n            } else {\n                let granularity = []\n                if (this.temp2.minuteFifteen) {\n                    granularity.push('15min')\n                }\n                if (this.temp2.minuteThirty) {\n                    granularity.push('30min')\n                }\n                if (this.temp2.hour) {\n                    granularity.push('1h')\n                }\n                if (this.temp2.day === '自然天') {\n                    granularity.push('1d')\n                }\n                if (this.temp2.month === '自然月') {\n                    granularity.push('1month')\n                }\n                if (this.temp2.year) {\n                    granularity.push('1y')\n                }\n                let data = {\n                    granularity: granularity.join(),\n                    dateDefinition: this.temp2.day === '自定义' ? this.temp2.dayDetail + '-' + this.temp2.dayDetail : '',\n                    monthDefinition: this.temp2.month === '自定义' ? this.temp2.monthDetail + '-' + this.temp2.monthDetail : ''\n                }\n                api.granularitySetting(this.projectCode, this.deviceCode, this.normCode, data, {\n                    method: 'NO'\n                }).then(() => {\n                    this.closeDialogGranularity()\n                    this.getList()\n                })\n            }\n        },\n        // 添加信息\n        createInfo: throttle(\n            function() {\n                this.$refs.tempRef.validate((valid) => {\n                    if (valid) {\n                        let flag1 = false\n                        let flag2 = false\n                        this.tableData.map((item) => {\n                            if (item.normName === this.temp.normName) {\n                                flag1 = true\n                            }\n                            if (item.normCode === this.temp.normCode) {\n                                flag2 = true\n                            }\n                        })\n                        if (flag1) {\n                            this.$message({\n                                message: '指标名称不能重复',\n                                type: 'warning',\n                                duration: 2000\n                            })\n                        } else if (flag2) {\n                            this.$message({\n                                message: '指标编码不能重复',\n                                type: 'warning',\n                                duration: 2000\n                            })\n                        } else {\n                            api.createInfo(this.projectCode, this.deviceCode, this.temp, {\n                                method: 'NO'\n                            }).then(() => {\n                                this.getList()\n                                this.closeDialog()\n                                this.$notify({\n                                    title: '成功',\n                                    message: '添加成功',\n                                    type: 'success',\n                                    duration: 2000\n                                })\n                            })\n                        }\n                    } else {\n                        return false\n                    }\n                })\n            },\n            2000,\n            {\n                leading: true,\n                trailing: false\n            }\n        ),\n        // 删除信息\n        deleteInfo(index, row) {\n            this.$confirm('此操作将删除所选中数据, 是否继续?', '提示', {\n                confirmButtonText: '确定',\n                cancelButtonText: '取消',\n                type: 'warning'\n            })\n                .then(() => {\n                    api.deleteInfo(this.projectCode, this.deviceCode, row.normCode, {\n                        methods: 'NO'\n                    }).then(() => {\n                        this.$message({\n                            message: '删除成功',\n                            type: 'success',\n                            duration: 2000\n                        })\n                        this.getList()\n                    })\n                })\n                .catch(() => {\n                    this.$message({\n                        type: 'info',\n                        message: '已取消删除'\n                    })\n                })\n        },\n        // 递归取第一个数据\n        getData(arr) {\n            if (arr[0].children) {\n                this.getData(arr[0].children)\n            } else {\n                this.treeRowId = [].concat(arr[0].rowId)\n                this.handleNodeClick(arr[0])\n            }\n        },\n        getTreeData(projectCode) {\n            // 清空数据\n            this.treeData = []\n            this.titleName = ''\n            this.tableData = []\n            this.total = 0\n            this.deviceCode = ''\n            // 下拉框选中重新赋值\n            if (projectCode) {\n                this.projectCode = projectCode\n            }\n            //获取树数据\n            api.getTree(this.projectCode).then((response) => {\n                if (response.data.length !== 0) {\n                    let temp = response.data\n                    response.data.map((item, index) => {\n                        temp[index].rowId = item.code\n                        temp[index].parentId = item.parentCode\n                    })\n                    this.treeData = this.$myFun.addTreeRoot(temp)[0].children\n                    this.getData(this.treeData)\n                    // this.treeData[0].name = '根⽬录'\n                }\n            })\n        },\n        //表格⾼度计算\n        setTableHeight() {\n            this.theight = this.$myFun.getSingleTbHeight()\n            this.contentStyleObj.height = this.theight + 'px'\n        },\n        // 树型菜单点击触发\n        handleNodeClick(data) {\n            if (data.deviceCode) {\n                this.titleName = data.name\n                this.deviceCode = data.deviceCode\n                this.getList()\n            }\n        },\n        // 获取表格数据\n        getList() {\n            this.listLoading = true\n            api.getInfo(this.projectCode, this.deviceCode, this.listQuery).then((res) => {\n                let options = [this.iot_is_standard]\n                res.data.list = this.$myFun.codeToName(res.data.list, options, ['isStandard'])\n                this.tableData = res.data.list\n                this.total = res.data.pages.count\n                setTimeout(() => {\n                    this.listLoading = false\n                }, 1.5 * 100)\n            })\n        }\n    }\n}\n",null]}