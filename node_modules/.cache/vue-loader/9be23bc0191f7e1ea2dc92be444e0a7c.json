{"remainingRequest":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/EL/equipmentRequisition/dialog/addMain.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yuan/Documents/大唐广电/dt-web/src/views/project/EAS/EL/equipmentRequisition/dialog/addMain.vue","mtime":1596610933380},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yuan/Documents/大唐广电/dt-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport * as api from '@/api/project/eas/el/equipmentRequisition'\nimport caiGou from '@/components/Select/xtpt/caigou' //下拉组件\nimport khxz from '@/components/Select/khxz'\nimport equipmentSelection from '@/components/Select/equipmentSelection.vue' //设备选择\nimport personSelect from '@/components/Select/personSelect.vue'\nimport addItems from './addItems' //下拉组件\nimport { mapState } from 'vuex'\nimport { DICT_CODE, DT_ORG_TYPE } from '@/utils/constant'\nimport { getDomainCode, getDomainCodeName } from '@/utils/auth'\nexport default {\n    components: { caiGou, addItems, khxz, personSelect, equipmentSelection },\n    data () {\n        return {\n            temp: {\n                supplierCode: undefined,\n                applicantName: getDomainCodeName(),\n                applicant: getDomainCode(),\n                arrivalTime: this.formatDate()\n            },\n            DICT_CODE: DICT_CODE,\n            DT_ORG_TYPE: DT_ORG_TYPE,\n            items: {},\n            tableKey: 0,\n            list: [],\n            listQuery: {\n                currentPage: 1,\n                pageSize: 15\n            },\n            dialogFormVisible: false,\n            dialogVisiblesqdw: false,\n            dialogVisiblePerson: false,\n            dialogStatus: '',\n            dialogVisible: false,\n            rowId: null,\n            parentRows: null,\n            parentRowsperson: null,\n            price: undefined,\n            number: undefined,\n            rules: {\n                orgCode: [\n                    {\n                        required: true,\n                        message: '采购组织不能为空',\n                        trigger: 'blur'\n                    }\n                ],\n                requisitionsOrgCode: [\n                    {\n                        required: true,\n                        message: '区分名称不能为空',\n                        trigger: 'blur'\n                    }\n                ],\n                applicantName: [\n                    {\n                        required: true,\n                        message: '请购人不能为空',\n                        trigger: 'blur'\n                    }\n                ],\n                arrivalTime: [\n                    {\n                        required: true,\n                        message: '到货时间不能为空',\n                        trigger: 'blur'\n                    }\n                ]\n            },\n            equipRows: []\n        }\n    },\n    computed: {\n        ...mapState({\n            dt_requisitions_type: state => state.eamDict.dt_requisitions_type\n        })\n    },\n    mounted () {\n        this.$store.dispatch('eamDict/getDicData', ['dt_requisitions_type'])\n    },\n    methods: {\n        formatDate () {\n            var date = new Date()\n            var y = date.getFullYear()\n            var m = date.getMonth() + 1\n            m = m < 10 ? '0' + m : m\n            var d = date.getDate()\n            d = d < 10 ? '0' + d : d\n            var h = date.getHours()\n            h = h < 10 ? '0' + h : h\n            var minute = date.getMinutes()\n            var second = date.getSeconds()\n            minute = minute < 10 ? '0' + minute : minute\n            second = second < 10 ? '0' + second : second\n            return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second\n        },\n        handleConfirm (val) {\n            this.list = val.map((v, index) => {\n                v.rowNo =\n                    (this.listQuery.currentPage - 1) * this.listQuery.pageSize +\n                    index +\n                    1\n                return v\n            })\n        },\n        dataList (val) {\n            val.rowNo = this.list.slice(-1)[0].rowNo + 1\n            val.estimatedCost = val.requisitionsQuantity * val.referencePrice\n            this.list.push(JSON.parse(JSON.stringify(val)))\n        },\n        //参考价格\n        getPrice (index, val) {\n            this.price = parseInt(val)\n            if (\n                (this.list &&\n                    this.list[index].requisitionsQuantity === undefined) ||\n                this.list[index].referencePrice === '' ||\n                this.list[index].requisitionsQuantity === ''\n            ) {\n                this.list[index].estimatedCost = ''\n            } else {\n                if (this.dialogStatus == 'update') {\n                    this.list[index].estimatedCost =\n                        this.price * this.list[index].requisitionsQuantity\n                } else {\n                    this.list[index].estimatedCost = this.price * this.number\n                }\n            }\n        },\n        //数量\n        getNumber (index, val) {\n            this.number = parseInt(val)\n            if (\n                (this.list && this.list[index].referencePrice === undefined) ||\n                this.list[index].referencePrice === '' ||\n                this.list[index].requisitionsQuantity === ''\n            ) {\n                this.list[index].estimatedCost = ''\n            } else {\n                if (this.dialogStatus == 'update') {\n                    this.list[index].estimatedCost =\n                        this.list[index].referencePrice * this.number\n                } else {\n                    this.list[index].estimatedCost = this.price * this.number\n                }\n            }\n        },\n        //获取采购组织名称\n        selectName (val) {\n            this.temp.orgName = val\n        },\n        //获取采购组织名称\n        selectNameunit (val) {\n            this.temp.requisitionsOrgName = val\n        },\n        //申请单位\n        handleApplicant () {\n            this.dialogVisiblesqdw = true\n        },\n        //申请单位\n        handlesqdw (val) {\n            this.parentRows = val\n        },\n        //申请单位确定\n        confirm () {\n            if (this.parentRows && this.parentRows.length === 1) {\n                this.$set(\n                    this.temp,\n                    'customerCode',\n                    this.parentRows[0].customerCode\n                )\n                this.$set(\n                    this.temp,\n                    'customerName',\n                    this.parentRows[0].customerName\n                )\n                this.dialogVisiblesqdw = false\n            } else {\n                this.$message({\n                    title: '警告',\n                    message: '请选择一条信息',\n                    type: 'warning'\n                })\n            }\n        },\n        //请购人选择\n        handlePerson () {\n            this.dialogVisiblePerson = true\n        },\n        //请购人选择\n        person (val) {\n            this.parentRowsperson = val\n        },\n        //请购人确定\n        confirmPerson () {\n            if (this.parentRowsperson && this.parentRowsperson.length === 1) {\n                this.$set(\n                    this.temp,\n                    'applicant',\n                    this.parentRowsperson[0].employeeCode\n                )\n                this.$set(\n                    this.temp,\n                    'applicantName',\n                    this.parentRowsperson[0].employeeName\n                )\n                this.dialogVisiblePerson = false\n            } else {\n                this.$message({\n                    title: '警告',\n                    message: '请选择一条信息',\n                    type: 'warning'\n                })\n            }\n        },\n        //选择按钮单击事件\n        handleSelect () {\n            if (\n                this.temp.orgCode &&\n                this.temp.requisitionsOrgCode &&\n                this.temp.applicantName &&\n                this.temp.arrivalTime\n            ) {\n                this.dialogFormVisible = true\n            } else {\n                this.$message({\n                    title: '警告',\n                    message: '请选择采购组织,申请单位,请购人及到货时间',\n                    type: 'warning'\n                })\n            }\n        },\n        handleEquip (row) {\n            this.equipRows = [...row]\n        },\n        selectConfirm () {\n            if (this.list.length == 0) {\n                this.equipRows.forEach((v, index) => {\n                    v.rowNo =\n                        (this.listQuery.currentPage - 1) *\n                        this.listQuery.pageSize +\n                        index +\n                        1\n                    this.list.push(JSON.parse(JSON.stringify(v)))\n                })\n            } else {\n                this.equipRows.forEach(v => {\n                    v.rowNo = this.list.slice(-1)[0].rowNo + 1\n                    this.list.push(JSON.parse(JSON.stringify(v)))\n                })\n            }\n            this.dialogFormVisible = false\n        },\n        //新增按钮单击事件\n        handleCreate () {\n            if (\n                this.temp.orgCode &&\n                this.temp.requisitionsOrgCode &&\n                this.temp.applicantName &&\n                this.temp.arrivalTime\n            ) {\n                this.$nextTick(() => {\n                    this.$refs.addItems.resetTemp()\n                })\n                this.$refs.addItems.dialogStatus = 'create'\n                this.$refs.addItems.dialogVisible = true\n            } else {\n                this.$message({\n                    title: '警告',\n                    message: '请选择采购组织,申请单位,请购人及到货时间',\n                    type: 'warning'\n                })\n            }\n        },\n        handleDelete () {\n            if (this.selectlistRow && this.selectlistRow.length > 0) {\n                this.$confirm('确认要删除该数据项吗?', '提示', {\n                    confirmButtonText: '确定',\n                    cancelButtonText: '取消',\n                    type: 'warning'\n                })\n                    .then(() => {\n                        this.selectlistRow.forEach(item => {\n                            this.list.forEach((val, indexs) => {\n                                if (item == val) {\n                                    this.list.splice(indexs, 1)\n                                }\n                            })\n                        })\n\n                        this.$message({\n                            type: 'success',\n                            message: '删除成功'\n                        })\n                    })\n                    .catch(() => {\n                        this.$message({\n                            type: 'info',\n                            message: '已取消'\n                        })\n                    })\n            } else {\n                this.$message.warning('请勾选记录！')\n                return\n            }\n        },\n        addConfirm () {\n            this.$refs.dataForm.validate(valid => {\n                if (valid) {\n                    // let status = this.list.every(v => {\n                    //     return v.referencePrice && v.estimatedCost\n                    // })\n                    let status = this.list.every(v => {\n                        return v.originalValue && v.requisitionsQuantity\n                    })\n                    if (status) {\n                        this.temp.deviceRequisitionsDetails = this.list.map(\n                            v => {\n                                let dto = {\n                                    category: v.category,\n                                    deviceName: v.deviceName,\n                                    manufacturersCode: v.manufacturersCode,\n                                    modelNumber: v.modelNumber,\n                                    referencePrice: v.originalValue,//originalValue referencePrice\n                                    requisitionsQuantity:\n                                        v.requisitionsQuantity, // requisitionsQuantity\n                                    supplierCode: v.supplierCode,\n                                    typeCode: v.typeCode,\n                                    accountQuantity: 0,\n                                    arrivalQuantity: 0,\n                                    handltor: this.temp.applicant,\n                                    handltorName: this.temp.applicantName\n                                }\n                                return dto\n                            }\n                        )\n                        api.addRecord(this.temp).then(() => {\n                            this.$message({\n                                title: '成功',\n                                message: '新增成功',\n                                type: 'success',\n                                duration: 2000\n                            })\n                            this.dialogVisible = false\n                            this.$emit('refresh')\n                        })\n                    } else {\n                        this.$message({\n                            title: '警告',\n                            message: '请填写参考价格与数量',\n                            type: 'warning'\n                        })\n                    }\n                } else {\n                    return false\n                }\n            })\n        },\n        updateConfirm () {\n            let status = this.list.every(v => {\n                return v.originalValue && v.requisitionsQuantity\n            })\n            if (status) {\n                this.temp.deviceRequisitionsDetails = this.list\n                this.temp.accountQuantity = 0\n                this.temp.arrivalQuantity = 0\n                api.updateRecord(\n                    this.temp.requisitionsOrderCode,\n                    this.temp\n                ).then(() => {\n                    this.$message({\n                        title: '成功',\n                        message: '编辑成功',\n                        type: 'success',\n                        duration: 2000\n                    })\n                    this.dialogVisible = false\n                    this.$emit('refresh')\n                })\n            } else {\n                this.$message({\n                    title: '警告',\n                    message: '请填写参考价格与数量',\n                    type: 'warning'\n                })\n            }\n        },\n        handleClose () {\n            this.resetTemp()\n            this.$refs.dataForm.resetFields()\n        },\n        // 获取表格选中时的数据\n        selectRow (val) {\n            this.selectlistRow = val\n        },\n        rowClick (val) {\n            this.$refs.tb.toggleRowSelection(val)\n        },\n        resetTemp () {\n            this.temp = {\n                requisitionsOrderCode: undefined,\n                requisitionsType: undefined,\n                orgCode: undefined,\n                customerName: undefined,\n                applicantName: getDomainCodeName(),\n                applicant: getDomainCode(),\n                arrivalTime: this.formatDate(),\n                reasons: undefined,\n                remark: undefined\n            }\n        },\n        resetItems () {\n            this.items = {\n                changeField: undefined,\n                beforeChange: undefined,\n                afterChange: undefined\n            }\n        }\n    }\n}\n",null]}